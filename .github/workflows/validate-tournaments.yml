name: Validate Tournament Data

on:
  pull_request:
    paths:
      - 'apps/website/frontend/src/features/tournaments/data/tournaments.json'
      - 'tournaments/validate.js'
  push:
    branches:
      - main
      - tournaments
    paths:
      - 'apps/website/frontend/src/features/tournaments/data/tournaments.json'
      - 'tournaments/validate.js'

jobs:
  validate:
    name: Validate tournaments.json
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run validation script
        id: validate
        run: |
          echo "Running validation..."
          node tournaments/validate.js 2>&1 | tee validation-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Comment on PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('validation-output.txt', 'utf8');
            const validationPassed = '${{ steps.validate.outputs.validation_passed }}' === 'true';

            let body;
            if (validationPassed) {
              body = '✅ **Tournament validation passed!**\n\nAll tournament data is valid.\n\n```\n' + output + '\n```';
            } else {
              body = '❌ **Tournament validation failed!**\n\nPlease fix the errors below and push again.\n\n```\n' + output + '\n```\n\nRun `node tournaments/validate.js` locally to validate before pushing.';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail job if validation failed
        if: steps.validate.outputs.validation_passed == 'false'
        run: |
          echo "Validation failed - blocking merge"
          exit 1
